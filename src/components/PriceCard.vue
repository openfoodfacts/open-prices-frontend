<template>
  <v-card :id="'price_' + price.id" data-name="price-card">
    <v-container class="pa-2">
      <v-row>
        <v-col v-if="!hideProductImage" style="max-width:15%">
          <v-img v-if="product && product.image_url" :src="product.image_url" style="max-height:50px;width:50px" @click="goToProduct()" />
          <v-img v-else :src="productImageDefault" style="height:50px;width:50px;filter:invert(.9);" />
        </v-col>
        <v-col :style="hideProductImage ? '' : 'max-width:85%'">
          <h3 v-if="!hideProductTitle" @click="goToProduct()">
            {{ productTitle }}
          </h3>

          <p v-if="!hideProductDetails" class="mb-2">
            <span v-if="hasProduct">
              <PriceCountChip :count="product.price_count" @click="goToProduct()" />
              <span v-if="hasProductSource">
                <ProductBrands :productBrands="product.brands" :readonly="readonly" />
                <ProductQuantityChip class="mr-1" :productQuantity="product.product_quantity" :productQuantityUnit="product.product_quantity_unit" />
              </span>
              <ProductMissingChip v-else />
            </span>
            <span v-else>
              <PriceOrigins v-if="hasPriceOrigin" class="mr-1" :priceOrigins="price.origins_tags" />
              <PriceLabels v-if="hasPriceLabels" class="mr-1" :priceLabels="price.labels_tags" />
            </span>
          </p>
        </v-col>
      </v-row>

      <PricePriceRow v-if="price" :price="price" :productQuantity="product ? product.product_quantity : null" :productQuantityUnit="product ? product.product_quantity_unit : null" :hidePriceDate="hidePriceDate" />

      <PriceFooterRow v-if="price && !hidePriceFooterRow" :price="price" :hidePriceLocation="hidePriceLocation" :hidePriceProof="hidePriceProof" :readonly="readonly" />
    </v-container>
  </v-card>
</template>

<script>
import { defineAsyncComponent } from 'vue'
import { mapStores } from 'pinia'
import { useAppStore } from '../store'
import utils from '../utils.js'

export default {
  components: {
    PriceCountChip: defineAsyncComponent(() => import('../components/PriceCountChip.vue')),
    ProductBrands: defineAsyncComponent(() => import('../components/ProductBrands.vue')),
    ProductQuantityChip: defineAsyncComponent(() => import('../components/ProductQuantityChip.vue')),
    ProductMissingChip: defineAsyncComponent(() => import('../components/ProductMissingChip.vue')),
    PriceOrigins: defineAsyncComponent(() => import('../components/PriceOrigins.vue')),
    PriceLabels: defineAsyncComponent(() => import('../components/PriceLabels.vue')),
    PricePriceRow: defineAsyncComponent(() => import('../components/PricePriceRow.vue')),
    PriceFooterRow: defineAsyncComponent(() => import('../components/PriceFooterRow.vue'))
  },
  props: {
    price: {
      type: Object,
      default: null
    },
    product: {
      type: Object,
      default: null
    },
    hideProductImage: {
      type: Boolean,
      default: false
    },
    hideProductTitle: {
      type: Boolean,
      default: false
    },
    hideProductDetails: {
      type: Boolean,
      default: false
    },
    hidePriceDate: {
      type: Boolean,
      default: false
    },
    hidePriceFooterRow: {
      type: Boolean,
      default: false
    },
    hidePriceLocation: {
      type: Boolean,
      default: false
    },
    hidePriceProof: {
      type: Boolean,
      default: false
    },
    readonly: {
      type: Boolean,
      default: false
    },
  },
  data() {
    return {
      productTitle: null,  // see init
      productImageDefault: 'https://world.openfoodfacts.org/images/icons/dist/packaging.svg',
    }
  },
  computed: {
    ...mapStores(useAppStore),
    hasProduct() {
      return !!this.product
    },
    hasPrice() {
      return !!this.price
    },
    hasCategoryTag() {
      return !!this.price.category_tag
    },
    hasProductId() {
      return this.hasProduct && !!this.product.id
    },
    hasProductCode() {
      return this.hasProduct && !!this.product.code
    },
    hasProductName() {
      return this.hasProduct && !!this.product.product_name
    },
    hasProductSource() {
      return this.hasProduct && !!this.product.source
    },
    hasPriceOrigin() {
      return this.hasPrice && !!this.price.origins_tags && this.price.origins_tags.length
    },
    hasPriceLabels() {
      return this.hasPrice && !!this.price.labels_tags && this.price.labels_tags.length
    },
  },
  mounted() {
    this.getPriceProductTitle()
  },
  methods: {
    getPriceProductTitle() {
      if (this.hasProductName) {
        this.productTitle = this.product.product_name
      } else if (this.hasPrice && this.price.product_code) {
        this.productTitle = this.price.product_code
      } else if (this.hasPrice && this.hasCategoryTag) {
        utils.getLocaleCategoryTagName(this.appStore.getUserLanguage, this.price.category_tag).then((categoryName) => {
          this.productTitle = categoryName
        })
      } else {
        this.productTitle = this.$t('PriceCard.UnknownProduct')
      }
    },
    getPriceProductCode() {
      if (this.hasProduct) {
        return this.product.code
      } else if (this.price.product_code) {
        return this.price.product_code
      } else if (this.price.category_tag) {
        return this.price.category_tag
      }
      return 'product code error'
    },
    goToProduct() {
      if (this.readonly) {
        return
      }
      this.$router.push({ path: `/products/${this.getPriceProductCode()}` })
    },
  },
}
</script>
